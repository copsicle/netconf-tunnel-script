# NETCONF Tunnel Script

An automated script to configure ISAKMP IPsec tunnels on Cisco IOS-XE Devices via NETCONF.

---

## Requirements

* Python 3.7+
* The ncclient library

## General Structure

There are 3 main files in the project:

1. `tunnelcfg.py` - Contains all the required functions for the tunnel setup and the main loop.

2. `xmltemplates.py` - Contains the required XML structures for querying and configuring devices.

3. `config.ini` - A configuration file which defines the inventory and options required to configure, an example is provided.

## Configuration File

The configuration file is in the INI format, it is defined with "static" and "dynamic" sections.

### "Static" Sections

There are 4 static sections in the configuration file:

#### `general`
Contains general options for the script:

* `enableospf` (Boolean) - Should OSPF be configured on the tunnel interfaces
* `setintassrc` (Boolean) - Should the tunnel source be the WAN interface (True) or the IP address (False)
* `getintfromip` (Boolean) - If the tunnel source is an interface, Should the interface get detected via the IP addresses we use to access the routers (True) or via a static definition in the configuration file (False)
* `getipfromint` (Boolean) - If the tunnel source is an IP address, Should the IP address be detected from a statically defined interface in the configuration file (True) or set as the IP addresses we use to access the routers (False)
* `generatepsk` (Boolean) - Is the PSK for IPsec automatically generated by the script (True) or set statically in the script (False)
* `overridepsk` (Boolean) - If a PSK already exists in a router towards a destination and it doesn't match with PSK defined in the script, the script will either override the PSK (True) or will not configure the tunnel (False)
* `secretlength` (Integer) - If the PSK is generated by the script, length for the randomly generated secret is required

#### `trset`
Contains options for the IPsec transform sets:

* `tag` (String) - The name of the transform set
* `esp` (String) - The transform set ESP algorithm
* `key-bit` (String) - The ESP algorithm key bit length

#### `profile`
Contains options for the IPsec profiles:

* `name` (String) - The name of the IPsec profile
* `group` (String) - The Diffie-Hellman group

#### `policy`
Contains options for the ISAKMP policy:

* `number` (String) - The ISAKMP policy priority 
* `authentication` (String) - The ISAKMP authentication type
* `encryption` (String) - The encryption spec
* `key` (String) - The encryption key bit size
* `group` (String) - The Diffie-Hellman group
* `hash` (String) - The hash type and key bit size
* `lifetime` (String) - The SA lifetime

### "Dynamic" Sections
Every router that is required must be configured in its own section (therefore the names and amount of sections is dynamic).
If the same router is required for two tunnels - another section for the same router is required since the PSK or the exit interface/IP might be different.
As per the INI format - each section must be uniquely named, the script

The options for each dynamic section are:

* `host` (String) - The IP address (dotted decimal) used for configuration
* `port` (String) - The port number used for NETCONF
* `user` (String) - The username used for configuration
* `pass` (String) - The password used for configuration
* `verify` (Boolean) - Should the public key of the router be verified against the local public key store
* `tunip` (String) - The IP address to configure on the tunnel interface
* `tunmask` (String) - The subnet mask to configure on the tunnel interface
* `inttype` (Optional String) - The interface type for static interface definition
* `intname` (Optional String) - The interface name (ID) for static interface definition
* `ospfid` (Optional String) - The OSPF Process ID to use
* `ospfarea` (Optional String) - The OSPF Area to use
* `psk` (Optional String) - Static definition of the PSK

## Validations

The script validates the following attributes in each router according to the options in the configuration file:

* IPsec Transform Set
* IPsec Profile
* ISAKMP Policy
* PSK
* Tunnel IP Addressing
* OSPF configuration (If enabled)

If a specfic feature has a conflicting option configured - the script will stop configuring the current tunnel and move on to the next pair of routers.

## General Usage

The script can be generally called via the command line, a few arguments are required - the name/path of the configuration file and the section names of the routers to configure (in pairs). The script will iterate over each pair of routers given:

```bash
python3 tunnelcfg.py config.ini router1 router2 router3 router4 ....
```

In the above example the configuration file named 'config.ini' is used (in the same folder as the script, a full path can be used instead) and tunnels are configured between the routers configured as sections 'router1' - 'router2' and 'router3' - 'router4'.
Due to the "even" nature of the amount of arguments the script requires (as tunnels are configured in pairs), a command with an odd number of arguments will be rejected.
